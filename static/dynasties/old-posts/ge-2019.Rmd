---
title: "General Elections"
author: ""
date: "2020-06-27"
params:
  orig_date: "Original Publish Date: 27 July, 2020"
  update_date: !r paste("Updated on:", format(Sys.time(), '%I:%m  %p -- %d %B, %Y'))
output:
  html_document:
    theme: readable
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
    number_sections: false
    fig_width: 6            
editor_options: 
  chunk_output_type: inline

---

---

### Document History

`r params$orig_date`

`r params$update_date`

---
```{r set up, warning=FALSE, include=FALSE, message= FALSE}

knitr::opts_chunk$set(cache = FALSE,echo = FALSE, message=FALSE, warning = FALSE)

##fig.width = 16/2, fig.height = 9/2

library(tidyverse)
library(data.table)
library(knitr)
library(kableExtra)
library(scales)
library(gridExtra)
library(stargazer)
`%!in%` = Negate(`%in%`)

select <- dplyr::select
```





```{r}



tcpd_5 <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/tcpd_ge_19_VS_corrected.csv") 
# 
# ge_5 <- readxl::read_xlsx("D:/cpr/UP/up-dynasties/dyn_other_data/tcpd_ge_09_14_19_JuneTR.xlsx") %>% select(c(1:5, dynast = dyn))
# 
# #names(ge_5) <- tolower(names(ge_5))
# 
# tcpd_5 <- left_join(tcpd_5, ge_5, by = c("State_Name","Year", "Constituency_No","Position"))

dynast  <-tcpd_5$dyn


incumbent <- tcpd_5$Incumbent

recontest <- tcpd_5$Recontest

bjp <- tcpd_5$bjp

sex <- tcpd_5$Sex

turncoat <- tcpd_5$turncoat

serious.case <- tcpd_5$serious_case

education <- tcpd_5$education

caste <-  case_when(str_detect(tcpd_5$Caste_Rec, "(UC)|(IC)") ~"UC+IC",
                   TRUE ~"Others")




enop <- tcpd_5$ENOP

vote.share.pc <- tcpd_5$Vote_Share_Percentage

contest <- tcpd_5$Contested

terms <- tcpd_5$No_Terms


assets <- tcpd_5$MyNeta_assets

winner <- tcpd_5$winner

age <- tcpd_5$MyNeta_age


reservation <- ifelse(tcpd_5$Constituency_Type == "GEN","GEN" ,"SC/ST")

turnout <- tcpd_5$Turnout_Percentage

state <- tcpd_5$State_Name



```





# GE 2019 {.tabset}

## summary

```{r}

table <- tcpd_5 %>% group_by(dynast) %>% summarise(Vote_Share = mean(Vote_Share_Percentage),
                                          Margin_ = mean(Margin_Percentage),
                                          N_cand = mean(N_Cand),
                                          enop = mean(ENOP),
                                          Turnout = mean(Turnout_Percentage),
                                          Incumbent = mean(Incumbent),
                                          Recontest = mean(Recontest),
                                          Contests = mean(Contested),
                                          No_terms = mean(No_Terms),
                                          Turncoat = mean(turncoat),
                                          Assets = mean(assets,na.rm =TRUE), 
                                          criminal_cases = mean(MyNeta_serious_criminal_cases,na.rm =TRUE),
                                          criminal_cases_no = mean(MyNeta_criminal_cases, na.rm =TRUE), 
                                          age = mean(age, na.rm =TRUE),
                                          bjp = mean(bjp))# %>% 
  #kable(digits = 2) %>% kable_styling(bootstrap_options = "striped")


kable(table[,1:9], digits = 2) %>%  kable_styling(bootstrap_options = "striped")
kable(table[,10:16], digits = 2) %>%  kable_styling(bootstrap_options = "striped")


# tcpd_5 %>% group_by(dynast,Sex) %>% summarise(count = n()) %>% group_by(dynast) %>% mutate(sum = sum(count), prop = count/sum) %>% select(dynast, Sex, prop) %>% filter(Sex == "F") %>% kable(digits = 2)

```

<!-- # Vote share linear model -->

```{r linear}
fit <- lm(vote.share.pc ~ bjp +  incumbent+  turncoat +caste+ sex + terms + dynast + assets  + serious.case+ education+age+ dynast*serious.case + state)

#summary(fit)

#stargazer(fit, type = "html")



```


<!-- # Winner probit model -->

```{r logistic, results = "asis"}



fit.logit <- glm(winner ~bjp +  incumbent+  turncoat +caste+ sex + terms + dynast + assets  + serious.case+ education+age+ dynast*serious.case+state ,family =  binomial(link = "probit"))


#summary(fit.logit)



```

<!-- # Turnout linear model -->

## Regressions


```{r turnout, results = "asis"}

fit.turnout <-  lm(turnout ~ bjp +  incumbent+  turncoat +caste+ sex + terms + dynast + assets  + serious.case+ education+age+enop +reservation+ dynast*serious.case + state)

stargazer(fit, fit.turnout, fit.logit, align = TRUE, no.space = TRUE, type = "html", keep = c("bjp", "incumbentTRUE" , "turncoatTRUE ","casteUC+IC " , "sexM" , "terms" , "dynast",
    "assets" , "serious.caseTRUE", "educationHIGHER" ,"age" ,"enop","reservationSC/ST", "dynast:serious.caseTRUE"),omit.stat=c("LL","ser","f"),add.lines=list(c('State fixed effects', 'Yes','Yes','Yes' )))


```


# GE 5 percent 

### India {.tabset}





```{r}
library(fixest)

library(lfe)

 #dyn_ge <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/tcpd_ge_09_14_19_dyn.csv")




# dyn_ge <-dyn_ge %>% select(1:1, 3:5,13:18)

 dyn_ge <- readxl::read_xlsx("D:/cpr/UP/up-dynasties/dyn_other_data/tcpd_ge_09_14_19_JuneTR.xlsx") %>%
   select(c(1:1, 3:5, 13:16,18:19)) %>% 
   mutate(dyn = ifelse(as.numeric(dyn)==1,1,0), dyn = ifelse(is.na(dyn),0,dyn))
 
 dyn_ge$State_Name <- tolower(dyn_ge$State_Name)




adr1 <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/adr_tcpd_09_14_19.csv") %>% filter(Vote_Share_Percentage>5 & !is.na(Year)& Year!= "") %>% distinct(Year,constituency_name_adr, candidate_adr, .keep_all = TRUE)%>% mutate(StateName = tolower(StateName)) 
# %>% 
# 
# select(c("StateName","Year","State_Name","Constituency_No","Position" ,"candidate_adr"  ,"constituency_name_adr","Party_adr" , "education","Age","total_assets","total_liabilities", "criminalcases","ipcs" ,"serious_crime","non_serious_crime"  ))
# 
# 
# ge_all <- fread("D:/cpr/data/tcpd/TCPD_GE_all.csv") %>% 
#   filter(Year>2008 & Vote_Share_Percentage >5 & Poll_No==0) %>% 
#   mutate(State_Name = tolower(State_Name),
#          State_Name = str_replace_all(string = State_Name, pattern = "_",
#             replacement = " "))
# 
#  adr1 <- inner_join(adr1, ge_all, by = c("Year","StateName"="State_Name","Constituency_No","Position")) %>% mutate(Age = Age.x)%>% 
#   select(-c(Age.y, Age.x)) 

adr <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/adr_tcpd_09_14_19.csv") 
 adr$State_Name <- tolower(adr$State_Name)



 

#adr1$constituency_name <- str_split(adr1$constituency_name_adr, pattern = "[(]", simplify = TRUE) [,1]

# adr1<- adr1 %>% mutate(adrname = tolower(adrname),
#                        candidate_adr = str_trim(adrname)
# )  

adr2 <- adr1%>% select(-c(State_Name, Constituency_Name))

  
  


  
  
dyn_ge_adr<-inner_join(dyn_ge, adr1, by = c("State_Name"= "StateName", "Year", "Constituency_No", "Position"))

names(dyn_ge_adr) <- tolower(names(dyn_ge_adr))



adr_ks_missing <-  fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/adr_ks_missing.csv") %>% 
  rename(
         "age" = "age.x",
         "party"= "party.y",
         
         "constituency_name" = "constituency_name.y") %>% 
  mutate(serious_crime  = 0,
         non_serious_crime = 0)


dyn_ge_adr<-rbindlist(list(adr_ks_missing,dyn_ge_adr), use.names = TRUE, fill = TRUE)

names(dyn_ge_adr)<- make.unique(names(dyn_ge_adr))

dyn_ge_adr$total_assets <- DescTools::Winsorize(as.numeric(dyn_ge_adr$total_assets), na.rm = TRUE,probs = c(.01,.99))



# inner_join(dyn_ge, adr_ks_match, by = c("State_Name"= "state_name", "Year" = "year", "Constituency_No" = "constituency_no", "Position" = "position"))
# 
# 
# adr_ks_anti <- dplyr::anti_join(dyn_ge, adr1, by = c("State_Name"= "StateName", "Year", "Constituency_No", "Position")) 
 
 # anti_join(dyn_ge, adr1, by = c("State_Name"= "StateName", "Year", "Constituency_No", "Position"))

# head(adr_ks$candidate_name)
# 
# adr1 %>% filter(grepl("gandam chandramouli",adrname,ignore.case = TRUE) )
# 
# names(adr_ks_missing)
```


```{r}
## adr binding
#
# ls09 <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/2009LokSabha.csv")%>% mutate(year= 2009, state_name = str_extract(constituency, pattern = "(?<=\\().*(?=\\))")) %>%
#   select(year,name,winner,`Party:`, constituency, state_name, name, winner)
# 
# ls09$constituency_name <- str_split(ls09$constituency, pattern = "[(]", simplify = TRUE) [,1]
# 
# ls09 <- ls09 %>% select(year, state_name, constituency_name,  candidate_name = name,winner, party = `Party:`, education, total_assets,)
# 
# ##
# 
# ls14 <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/2014LokSabha.csv")%>% mutate(year= 2014, state_name = str_extract(constituency, pattern = "(?<=\\().*(?=\\))")) %>%
#   select(year,name,winner,`Party:`, constituency, state_name, name, winner)
# 
# ls14$constituency_name <- str_split(ls14$constituency, pattern = "[(]", simplify = TRUE) [,1]
# #
# ls14 <- ls14 %>% select(year, state_name, constituency_name,  candidate_name = name, winner, party = `Party:`)
# #
# 
# ###
# 
# ls19 <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/2019LokSabha.csv") %>% mutate(year= 2019, state_name = str_extract(constituency, pattern = "(?<=\\().*(?=\\))")) %>%
#   select(year,name,winner,`Party:`, constituency, state_name, name, winner)
# 
# ls19$constituency_name <- str_split(ls19$constituency, pattern = "[(]", simplify = TRUE) [,1]
# 
# ls19 <- ls19 %>% select(year, state_name, constituency_name,  candidate_name = name, winner, party = `Party:`)
# 
# ls_adr <- rbindlist(list(ls09,ls14,ls19), use.names = TRUE)
#
# fwrite(ls_adr,"D:/cpr/UP/up-dynasties/dyn_other_data/adr/ls_adr.csv")
#
# ls19 %>% filter(Vote_Share_Percentage>5)
#
# dyn_ge %>% filter(Year==2009)
#
# unlist(strsplit(head(ls19$constituency), split="[())]"))
#
# ls19
# str_extract(head(ls14$constituency,20), pattern = "(?<=\\().*(?=\\))")

```


```{r}



dyn_ge_adr  <- dyn_ge_adr %>% mutate(edu = case_when(education %in% c("5th Pass","10th Pass","8th Pass") ~"10",
                                  education == "12th Pass" ~"12",
                                  education %in% c("Graduate","Graduate Professional") ~"14",
                                  education == "Post Graduate" ~ "16",
                                  education == "Doctorate" ~"18",
                                  education %in% c("Literate","Others") ~"5",
                                  TRUE ~ "0"
                                  
                                  
                                  ))



```




```{r}

dynast  <- dyn_ge_adr$dyn

incumbent <- dyn_ge_adr$incumbent

recontest <- dyn_ge_adr$recontest

#bjp <- dyn_ge_adr$bjp

female<- ifelse(dyn_ge_adr$sex=="F",1,0)


# gender <- relevel(gender, ref = "M")

turncoat <- dyn_ge_adr$turncoat

serious_crime <- ifelse(dyn_ge_adr$serious_crime>0,1,0)




education <- as.numeric(dyn_ge_adr$edu)

# caste <-  case_when(str_detect(dyn_ge_adr$caste_rec, "(UC)|(IC)") ~"UC+IC",
#                    TRUE ~"Others")


caste_UC_IC <- as.numeric(case_when(str_detect(dyn_ge_adr$caste_rec, "(UC)|(IC)") ~"1",
                   TRUE ~"0"))
# 
# dyn_ge_adr %>% group_by(position) %>% filter(caste_rec=="NA") %>% tally()

enop <- dyn_ge_adr$enop

vote_share_pc <- dyn_ge_adr$vote_share_percentage

#contest <- dyn_ge_adr$contested

terms <- dyn_ge_adr$no_terms

inc <- ifelse(dyn_ge_adr$party=="INC",1,0)

bjp <-  ifelse(dyn_ge_adr$party=="BJP",1,0)


assets <- as.numeric(dyn_ge_adr$total_assets)

winner <- ifelse(dyn_ge_adr$position==1,1,0)



age <- as.numeric(dyn_ge_adr$age)


reservation_SCST <- ifelse(dyn_ge_adr$constituency_type == "GEN",0 ,1)

turnout <- dyn_ge_adr$turnout_percentage




state <- dyn_ge_adr$state_name

year <- dyn_ge_adr$year

constituency <- dyn_ge_adr$constituency_name_adr

constituency_no <-  dyn_ge_adr$constituency_no

party <- dyn_ge_adr$party


margin_percentage <- dyn_ge_adr$margin_percentage

dynast_winner <- ifelse( dyn_ge_adr$position==1 &  dyn_ge_adr$dyn==1,1,0)

uc_ic_winner <- ifelse( dyn_ge_adr$position==1 &  caste_UC_IC ==1,1,0)

incumbent_winner <- ifelse( dyn_ge_adr$position==1 &  incumbent ==1,1,0)

asset_quartile <- ntile(assets,4)

asset_winner <- ifelse(dyn_ge_adr$position==1 & asset_quartile==4,1,0)


ser_crime_winner <- ifelse(dyn_ge_adr$position==1 & serious_crime==1,1,0)




position <- dyn_ge_adr$position

enop <- dyn_ge_adr$enop

#turnout <- dyn_ge_adr$turnout_percentage


last_year <- dyn_ge_adr %>%filter(position ==1)%>%  
  
  mutate(year = year-5, lagged_turnout = turnout_percentage,lagged_margin = margin_percentage, value = NULL) %>% select(state_name,year, constituency_no, lagged_turnout, lagged_margin) %>% distinct(state_name,year, constituency_no, .keep_all = TRUE)

dyn_ge_adr <- dyn_ge_adr %>% left_join(last_year, by = c("state_name","year", "constituency_no"))



lagged_margin <- dyn_ge_adr$lagged_margin

lagged_turnout <- dyn_ge_adr$lagged_turnout


 dynast_1_2 <- dyn_ge_adr %>% group_by(state_name,year, constituency_no) %>% mutate(dynast_1_2 =ifelse(any( position %in% c(1,2)) & any( dyn==1),1,0)) %>%ungroup()%>% select(dynast_1_2)
 
dyn_ge_adr$serious_criminal <- ifelse(as.numeric(dyn_ge_adr$serious_crime)>0,1,0)
 
 
criminal_1_2 <- dyn_ge_adr %>% group_by(state_name,year, constituency_no) %>% mutate(criminal_1_2 =ifelse(any( position %in% c(1,2)) & any( serious_criminal==1),1,0)) %>%ungroup()%>% select(criminal_1_2)
# 
# df <- tibble(winner ,   incumbent,  turncoat , female , terms , dynast , assets  , serious_crime,  year,enop, reservation_SCST,recontest, constituency, party, vote_share_pc, inc, bjp, margin_percentage,  position, turnout, sub_region,immovable_assets,movable_assets,mov_assets_ratio , caste_uc, caste_sc, caste_muslim, caste_obc, dynast_1_2, lagged_margin, lagged_turnout)

df <- tibble(winner ,   incumbent,  turncoat ,caste_UC_IC, female , terms , dynast , assets  , serious_crime, education,age, state,year,enop, reservation_SCST,recontest, constituency, party, vote_share_pc, inc, bjp, margin_percentage, dynast_winner, position, turnout, asset_winner, incumbent_winner, uc_ic_winner, ser_crime_winner,dynast_1_2, lagged_margin, lagged_turnout, criminal_1_2, constituency_no)
# 
# df_cor <- tibble(winner ,   incumbent,  turncoat , terms , dynast , assets  , serious_crime, education,age,year, enop,recontest)
# 
# 
# 
# corr <- cor(df_cor, use = "complete.obs")
# 
# corrplot::corrplot(corr, method = "circle")


```




#### Summaries {.tabset}

##### All



```{r}
mean <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~mean(., na.rm = TRUE))

min <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~min(., na.rm = TRUE))

max <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~max(., na.rm = TRUE))

unique_n<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "uniqueN"))

n<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "length"))


sd<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(sd= "sd"))

stat <-as.data.frame(c("Length", "Unique-N","Mean", "SD","Min", "Max")) %>% rename("stat"=1:1)







vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE) 
names(vals) <- str_remove( names(vals),"_n")


cbind(stat, vals) %>% 
  #pivot_longer(cols = 2:13) %>% pivot_wider(names_from = stat, values_from = value) %>% 
  kable(digits = 2,  caption = "Summary of GE 5% data") %>% kable_styling(full_width = F)

```


##### Dynasts


```{r}
mean <- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~mean(., na.rm = TRUE))

min <- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~min(., na.rm = TRUE))

max <- df%>% group_by(dynast) %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~max(., na.rm = TRUE))

unique_n<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "uniqueN"))

n<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "length"))


sd<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(sd= "sd"))

stat <-as.data.frame(c("Length","Length", "Unique-N","Unique-N","Mean", "Mean","SD","SD","Min","Min","Max","Max")) %>% rename("stat"=1:1)




vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE) 


names(vals) <- str_remove( names(vals),"_n")

vals$dynast <- ifelse(vals$dynast==1,"Family","Non-fam")




cbind(stat, vals) %>%filter(dynast=="Family") %>% 
  #pivot_longer(cols = 3:13) %>% pivot_wider(names_from = c(stat,dynast), values_from = value) %>% 
  kable(digits = 2,  caption = "Summary of GE 5% data - Families") %>% kable_styling(full_width = F)



```

---


```{r}
cbind(stat, vals) %>%filter(dynast!="Family") %>% 
  #pivot_longer(cols = 3:13) %>% pivot_wider(names_from = c(stat,dynast), values_from = value) %>% 
  kable(digits = 2,  caption = "Summary of GE 5% data - Non-families") %>% kable_styling(full_width = F)


```


##### 5PC v/s rest


```{r}

ge0919 <- fread("D:/cpr/UP/up-dynasties/dyn_other_data/adr/adr_tcpd_09_14_19.csv")

names(ge0919) <- tolower(names(ge0919))

ge0919 <-ge0919 %>% mutate(vote_share = cut(vote_share_percentage, breaks = c(-Inf,5,Inf), labels = c("<5","5+")),
                           female = ifelse(sex=="F", 1,0),
                           edu = case_when(education %in% c("5th Pass","10th Pass","8th Pass") ~"10",
                                  education == "12th Pass" ~"12",
                                  education %in% c("Graduate","Graduate Professional") ~"14",
                                  education == "Post Graduate" ~ "16",
                                  education == "Doctorate" ~"18",
                                  education %in% c("Literate","Others") ~"5",
                                  TRUE ~ "0"
                                  
                                  
                                  ))




ge0919 <- ge0919 %>% mutate(across(c(total_assets, total_liabilities, edu, age), as.numeric)) %>% mutate(assets_million = (total_assets)/1000000, liabilities_million = (total_liabilities)/1000000)



count <- ge0919 %>% filter(!is.na(vote_share))%>% group_by(vote_share) %>% summarise(count = n())


ge0919 %>% filter(!is.na(vote_share))%>% group_by(vote_share) %>% summarise_at( c("vote_share_percentage", "incumbent", "turncoat" ,"female" , "no_terms", "assets_million", "liabilities_million","serious_crime","non_serious_crime", "edu","age" ),~mean(., na.rm = TRUE)) %>% inner_join(count, by ="vote_share")%>% select(1:1, 13:13, everything())%>% 
  pivot_longer(cols = 2:13) %>% pivot_wider(names_from = vote_share, values_from = value) %>% select(1:1,3:3, 2:2)%>% kable(digits = 2, col.names = c("Varibale","5+","<5")) %>% kable_styling(full_width = F)


```

##### AC summary

```{r}


dyn_ge_adr$serious_criminal <- ifelse(dyn_ge_adr$serious_crime>0,1,0)


#dyn_ge_adr$asset_median <- 

dyn_ge_adr <- dyn_ge_adr %>% group_by(state_name, year) %>% mutate( st_median_asset = median(as.numeric(total_assets), na.rm = TRUE)) %>% ungroup()

dyn_ge_adr <- dyn_ge_adr %>% group_by(state_name, year, constituency_no) %>% mutate(ac_avg_assets = mean(as.numeric(total_assets), na.rm = TRUE) )

dyn_ge_adr <- dyn_ge_adr %>% 
  group_by(state_name, year, constituency_no) %>% 
  mutate(dyn_vs_nondyn = ifelse(any(dyn==1) & any(dyn==0),1,0),
         dyn_won = ifelse(any(dyn==1 & position==1),1,0), 
         dyn_contest = ifelse(any(dyn==1),1,0),
         criminal_contest = ifelse(any(serious_criminal==1),1,0),
         asset_median = ifelse(ac_avg_assets>st_median_asset,1,0)
                                                                                    )


```



```{r}
dyn_ge_adr %>%ungroup() %>% 
  distinct(state_name, year, constituency_no, .keep_all = TRUE) %>% 
  group_by(year) %>% 
  summarise (dyn_contest = mean(dyn_contest),
             dyn_won = mean(dyn_won),
             criminal_contest = mean(criminal_contest),
             median_assets = mean(asset_median)
)%>% kable(digits = 2, col.names = c("Year","% of PCs in dynast contested","% of PCs in dynast won","% of PCs in a serious criminal contested","% of PCs in PC average assets is higher than the state median")) %>% 
  kable_styling(full_width = F)
```


```{r}

#dyn_ge_adr$dynat_winner <- ifelse(dyn_ge_adr$dynast ==1 &dyn_ge_adr$position ==1,1,0)

dyn_ge_adr <- dyn_ge_adr %>% group_by(state_name, year, constituency_no) %>% mutate(n_cand_ac = n(), criminal_cand_ac = sum(serious_criminal), dyn_contested_ac = sum(dyn), dynast_winner = ifelse(dyn ==1 &position ==1,1,0))

dyn_ge_adr %>%ungroup() %>% filter(year==2014) %>%
  distinct(state_name, year, constituency_no, .keep_all = TRUE) %>% select(state_name, year, constituency_no,n_cand_ac,dyn_contested_ac, dynast_winner, criminal_cand_ac) %>%arrange(state_name, constituency_no) %>%  write.csv("D:/cpr/UP/up-dynasties/dyn_other_data/ge14_pc_stats.csv")

```


#### Other stats {.tabset}

##### retention


```{r}

dyn_ae_ge <- read.csv("D:/cpr/UP/up-dynasties/dyn_other_data/dyn_ae_ge.csv")

  # dyn_ae_ge %>% group_by(dyn_cum_2,position) %>% summarise(recontest = mean(recontest)) %>% pivot_wider(names_from = dyn_cum_2, values_from = recontest) %>% kable(digits = 2, col.names = c("Position","non-fam renomination", "fam renomination"), caption = "AE-GE All") %>% kable_styling(full_width = F)

```


```{r}

dyn_ge_adr $position_rev <- ifelse(dyn_ge_adr$position>2,"3+",position)

dyn_ge_adr %>% group_by(dyn,position_rev) %>% summarise(recontest = mean(recontest, na.rm = TRUE)) %>% pivot_wider(names_from = dyn, values_from = recontest) %>% kable(digits = 2, col.names = c("Position","non-fam renomination", "fam renomination"), caption = "GE Pan India 09:19") %>% kable_styling(full_width = F)


```

##### serious crime

```{r}

dyn_ge_adr$serious_criminal <- ifelse(dyn_ge_adr$serious_crime>0,1,0)


dyn_ge_adr %>% group_by(serious_criminal,position_rev) %>% summarise(recontest = mean(recontest, na.rm = TRUE)) %>% pivot_wider(names_from = serious_criminal, values_from = recontest) %>% kable(digits = 2, col.names = c("Position","non-criminal renomination", "criminal renomination"), caption = "GE Pan India 09:19") %>% kable_styling(full_width = F)



```


#### Winner

```{r results="asis"}

df$constituency_id <- paste0(df$state,df$constituency_no)

fit_year <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age+ inc + bjp | year, family = binomial(link = "probit" ), data = df )


fit_state <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age+ inc + bjp | state+year,  family = binomial(link = "probit" ),data = df )

fit_ac <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age + inc + bjp| state+year+constituency_id, family = binomial(link = "probit" ), data = df )


fit_party <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age | state+year+constituency_id, family = binomial(link = "probit" ), data = df )


order = c("dynast" ,"winner" , "vote_share_pc", "incumbent",  "turncoat" , "terms",  "assets", "serious_crime", "education", "age","caste_UC_IC", "female", "inc","bjp")



etable(fit_year,fit_state, fit_ac, fit_party, cluster = c("state","constituency"), order = order) %>% kable() %>% kable_styling(full_width = F)



```


#### Vote share

```{r results="asis"}


fit_year <- felm(vote_share_pc ~   incumbent+  turncoat + female+  terms + dynast + log(assets)  + serious_crime+ education+age+ inc + bjp | year, data = subset(df %>% filter(assets>0))  )




fit_state <- felm(vote_share_pc ~   incumbent+  turncoat + female+  terms + dynast + log(assets)  + serious_crime+ education+age+ inc + bjp | year+state|0|state, data = subset(df %>% filter(assets>0))  )



fit_ac<- felm(vote_share_pc ~   incumbent+  turncoat + female+ terms + dynast + log(assets)  + serious_crime+ education+age+ inc + bjp | year+state+constituency_id|0|constituency_id+state, data = subset(df %>% filter(assets>0)) )



# etable(fit_year,fit_state,fit_ac, fit_party, cluster = c("state","constituency"), order = order) %>% kable(caption = "UP vote share")


list <- list(c("Fixed effects","Year" , "Year + State", "Year + State + Constiuency"), c("SE Clustered", "None","State","Constituency+ State" ))



stargazer( fit_year,fit_state,fit_ac,title="Vote share - India ",type = "html",
align=TRUE, no.space=TRUE, order = order,add.lines=list)

```

---

#### states {.tabset}

##### Pan India stats

```{r}

names(dyn_ge) <- tolower(names(dyn_ge))

dyn_ge  %>% ungroup()  %>% filter(position %in% c(1,2)) %>% group_by(year ) %>% summarise(count = sum(position==1),
                                             dyn = sum(dyn[position==1]),
                                             prop_dyn = dyn/count,
                                             count_1_2 = n() ,
                                              dyn_1_2 = sum(dyn),
                                             prop_dyn_1_2 = dyn_1_2/count_1_2,
                                             
                                            ) %>%
  select(year, 4:4,7:7) %>% 
  kable(col.names = c("Year","Family politicians among winners",
                      "Family politicians among winners and runner ups"), digits = 2) %>% 
  kable_styling(full_width = F)



```

---

##### States - all positions


```{r, fig.width=8}




dyn_ge %>%filter(position %in% c(1,2)) %>% group_by(state_name, year ) %>% summarise(count = n(),
                                             dyn_1_2 = sum(dyn),
                                             prop_dyn_1_2 = dyn_1_2/count) %>%
  filter(count>10 & prop_dyn_1_2 >0) %>%select(state_name, year,prop_dyn_1_2) %>% filter(state_name %!in% c("jammu & kashmir","jharkhand") )%>% ungroup() %>% 
  ggplot(aes(prop_dyn_1_2, reorder(state_name, - prop_dyn_1_2), label = round(prop_dyn_1_2,2)))+
  geom_bar(stat ="identity", fill = "steelblue")+
  labs(title = "Family politicians among winners and runner-ups", subtitle = "Loksabha elections - 2009:19", x = "", y ="")+

  facet_wrap(~year)+
  #  scale_x_continuous(labels = c(".0",".1",".2",".3",".4",".5"))+
  geom_text(hjust=1, size = 3, color = "white")+
  theme_minimal()+
    theme(
       # plot.background = element_blank(),
        # plot.title = element_text( size = 18, family = "serif"),
        # plot.subtitle = element_text( size = 15,
        #                              margin = margin(t = 0, r = 0, b = 20, l = 0)),
        text = element_text(color = "gray20",family = "serif"),
        axis.text.x =element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text = element_text(face = "italic", size = 10),
        axis.title = element_text(vjust = -1, size = 15),        
        axis.ticks = element_blank(),
         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.line.x = element_line()
  ) 

 

```



##### States - winners

```{r}
dyn_ge %>% filter(position ==1)%>% group_by(state_name, year ) %>% summarise(count = n(),
                                                                             dyn= sum(dyn),
                                             prop_dyn_1_2 = dyn/count) %>%
  filter(prop_dyn_1_2>0 & count>5)%>%
select(state_name, year,prop_dyn_1_2) %>% filter(state_name %!in% c("jammu & kashmir","jharkhand") )%>% ungroup() %>% 
  ggplot(aes(prop_dyn_1_2, reorder(state_name, - prop_dyn_1_2), label = round(prop_dyn_1_2,2)))+
  geom_bar(stat ="identity", fill = "steelblue")+
  labs(title = "Family politicians among winners ", subtitle = "Loksabha elections - 2009:19", x = "", y ="")+

  facet_wrap(~year)+
    #scale_x_continuous(labels = c(".0",".1",".2",".3",".4",".5"))+
  geom_text(hjust=1, size = 3, color = "white")+
  theme_minimal()+
    theme(
       # plot.background = element_blank(),
        # plot.title = element_text( size = 18, family = "serif"),
        # plot.subtitle = element_text( size = 15,
        #                              margin = margin(t = 0, r = 0, b = 20, l = 0)),
        text = element_text(color = "gray20",family = "serif"),
        axis.text.x =element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        axis.text = element_text(face = "italic", size = 10),
        axis.title = element_text(vjust = -1, size = 15),        
        axis.ticks = element_blank(),
         axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.line.x = element_line()
  ) 

 
```


#### turnout {.tabset}

##### turnout


```{r results = "asis"}



fit.1 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2|0|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))



fit.2 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2|year|0|state, data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))

fit.3 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2|state|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))

fit.4<- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2| state+year|0|state, data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))




fit.5<- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2 | constituency_id+ state+year|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))


addlines <- list(c('Fixed effects', '' ,"Year", "State","Year and State","State, Year and Constituency"), c("Clustered SE" ,"State","State","State","State", "State"))


 
stargazer(fit.1, fit.2, fit.3, fit.4, fit.5,type = "html", add.lines = addlines)

#summary(fit.4)

```

##### lagged turnout


```{r results = "asis"}

fit.1 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2+lagged_turnout|0|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))



fit.2 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2+lagged_turnout|year|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))
fit.3 <- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2+lagged_turnout|state|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))

fit.4<- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2+lagged_turnout| state+year|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))




fit.5<- felm(turnout~  dynast_1_2+ reservation_SCST + margin_percentage+enop+criminal_1_2+lagged_turnout|constituency_id+ state+year|0|state,data = subset(df %>% distinct(year,constituency,.keep_all =TRUE)))


addlines <- list(c('Fixed effects', '' ,"Year", "State","Year and State","State, Year and Constituency"), c("Clustered SE" ,"State","State","State","State", "State"))


 
stargazer(fit.1, fit.2, fit.3, fit.4, fit.5,type = "html", add.lines = addlines, title = "lagged turnout")

```


#### Margin {.tabset}

##### Margin



```{r results = "asis" }



fit.1 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop|0|0|state, data = subset(df %>% filter(position==1) %>% distinct(year,constituency,.keep_all =TRUE)))



fit.2 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST +turnout+enop|year|0|state, data = subset(df %>% filter(position==1) %>% distinct(year,constituency,.keep_all =TRUE)))

fit.3 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST +turnout+enop|state|0|state, data = subset(df %>% filter(position==1) %>% distinct(year,constituency,.keep_all =TRUE)))

fit.4<- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop| state+year|0|state, data = subset(df %>% filter(position==1) %>% distinct(year,constituency,.keep_all =TRUE)))




fit.5<- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop|constituency_id+ state+year|0|state, data = subset(df %>% filter(position==1) %>% distinct(year,constituency,.keep_all =TRUE)))


addlines <- list(c('Fixed effects', '' ,"Year", "State","Year and State","State, Year and constituency_name_adr"), c("Clustered SE" ,"State","State","State","State", "State"))


 
stargazer(fit.1, fit.2, fit.3, fit.4, fit.5,type = "html", add.lines = addlines)

```

##### lagged margin

```{r results = "asis"}


fit.1 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop+lagged_margin|0|0|state, data = subset(df %>% filter(position==1)))



fit.2 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST +turnout+enop+lagged_margin|year|0|state, data = subset(df %>% filter(position==1)))

fit.3 <- felm(margin_percentage~  dynast_1_2+ reservation_SCST +turnout+enop+lagged_margin|state|0|state, data = subset(df %>% filter(position==1)))

fit.4<- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop+lagged_margin| state+year|0|state, data = subset(df %>% filter(position==1)))




fit.5<- felm(margin_percentage~  dynast_1_2+ reservation_SCST + turnout+enop+lagged_margin | constituency_id+ state+year|0|state, data = subset(df %>% filter(position==1)))


addlines <- list(c('Fixed effects', '' ,"Year", "State","Year and State","State, Year and constituency_name_adr"), c("Clustered SE" ,"State","State","State","State", "State"))


 
stargazer(fit.1, fit.2, fit.3, fit.4, fit.5,type = "html", add.lines = addlines, title = "margin percentage lagged")

```






#### misc. models

```{r}
df_win <- df %>% mutate(year = as.factor(year), constituency= as.factor(constituency))%>% filter(!is.na(state)&!is.na(year)&!is.na(constituency)&assets>0)

df_win$non_dyn_win <- ifelse(df_win$dynast==1,0,1)
# 
# fit_ac <- feglm(dynast_winner ~  margin_percentage+reservation_SCST + turnout| state+year+constituency_id, family = binomial(link = "probit" ), data = df)
# 
# 
# etable(fit_ac, cluster= c("state","constituency")) %>% kable(caption = "Dynast winner - winners data")
# data = subset(df %>% filter(position ==1))
# 
# 
# fit_lm <- felm(dynast_winner ~  margin_percentage+ incumbent+  turncoat + female + terms + log(assets)  + serious_crime+ education+age + inc + bjp| factor(state)+factor(year)+factor(constituency),data =df_win)
```


```{r}
fit_dyn <- felm(dynast_winner ~  margin_percentage+reservation_SCST + turnout+enop| state+year+constituency_id|0|constituency_id, data = df)


fit_uc <- felm(uc_ic_winner~  margin_percentage+ reservation_SCST + turnout+enop| state+year+constituency_id|0|constituency_id,  data = df)


fit_incumbent<- felm(incumbent_winner~ margin_percentage+reservation_SCST + turnout+enop| state+year+constituency_id|0 |constituency_id,  data = df)


fit_asset <- felm(asset_winner~ margin_percentage+ reservation_SCST + turnout+enop| state+year+constituency_id|0|constituency_id, data = df)


fit_crime<- felm(ser_crime_winner~ margin_percentage+reservation_SCST + turnout+enop| state+year+constituency_id|0|constituency_id, data = df)

# 
# etable(fit_dyn, fit_uc,fit_incumbent, fit_asset,fit_crime,cluster= c("state","constituency")) %>% kable(caption = "*** winners - 5 PC")
```


```{r results="asis"}
stargazer(fit_dyn, fit_uc,fit_incumbent, fit_asset,fit_crime, type = "html", add.lines = list(c("Fixed effects", "State+Year+constituency-id","State+Year+constituency-id", "State+Year+constituency-id" ,"State+Year+constituency-id","State+Year+constituency-id")),c("Clustered SE","Constituency","Constituency","Constituency","Constituency","Constituency"))

```


<!-- ```{r} -->
<!-- library(jtools) -->

<!-- effect_plot(fit_lm, pred = margin_percentage, interval = FALSE, y.label = "Probability of dynast winning")+ -->
<!--   ylim(0,1) -->

<!-- fit_ac$fitted.values[,1] -->

<!-- fit_ac$coeftable# -->

<!-- fit_ac$coef[1] -->


<!-- ggplot(subset(df %>% filter(position ==1)), aes(margin_percentage,dynast_winner ))+ -->
<!--   geom_point()+ -->
<!--    geom_smooth(method = "glm", method.args = list(family = binomial(link = "probit") ) -->
<!--                 )  -->

<!-- pred <-  predict(fit_ac) -->


<!-- plot(p, data=subset(df %>% filter(position ==1)), col="red4") -->
<!-- lines(vs ~ hp, newdat, col="green4", lwd=2) -->

<!-- ``` -->


<!-- #### close election rdd -->



```{r}

# dyn_ge_adr <- dyn_ge_adr %>% group_by(state_name, year, constituency_no) %>% mutate(dyn_vs_nondyn = ifelse(any(dyn==1) & any(dyn==0),1,0), dyn_w_vs_nondyn = ifelse(dyn==1 & position==1 &dyn==1,1,0))
# 
# 
# rdd <- dyn_ge_adr  %>% filter(dyn_vs_nondyn==1&margin_percentage<=5 &position==1) %>% mutate(mv = ifelse(dyn==0,-margin_percentage, margin_percentage)) %>% select(state_name,year,constituency_no,dyn,margin_percentage,mv)
# 
# rdd <- rdd %>% rename(dynast = dyn_cum_2)
# 
# 
# 
# ggplot(rdd %>% filter(cv<2.5), aes(mv,cv , color = factor(dynast)))+
#   geom_point()+
#     geom_smooth(method="lm", se= FALSE)+
#   geom_vline(xintercept = 0)+
#     scale_color_discrete(labels = c("non-dynast winner", "dynast winner"))+
#   #guides(color = FALSE)+
#   ylim(0,1)+
#    labs(x = "Margin of victory", y = "co-efficient of variation")+
#   theme(legend.position = "bottom", legend.title = element_blank())

```


### UP {.tabset}


```{r}


dyn_up_ge_adr <- dyn_ge_adr %>% filter(state_name =="uttar pradesh")


dynast  <-dyn_up_ge_adr$dyn

incumbent <- dyn_up_ge_adr$incumbent

recontest <- dyn_up_ge_adr$recontest

#bjp <- dyn_up_ge_adr$bjp

gender <- factor(ifelse(dyn_up_ge_adr$sex=="F","F","M"))


gender <- relevel(gender, ref = "M")

turncoat <- dyn_up_ge_adr$turncoat

serious_crime <- ifelse(dyn_up_ge_adr$serious_crime>0,1,0)


inc <- ifelse(dyn_up_ge_adr$party=="INC",1,0)

bjp <-  ifelse(dyn_up_ge_adr$party=="BJP",1,0)

education <- as.numeric(dyn_up_ge_adr$edu)

# caste <-  case_when(str_detect(dyn_up_ge_adr$caste_rec, "(UC)|(IC)") ~"UC+IC",
#                    TRUE ~"Others")

caste_UC_IC <- as.numeric(case_when(str_detect(dyn_up_ge_adr$caste_rec, "(UC)|(IC)") ~"1",
                   TRUE ~"0"))

female<- ifelse(dyn_up_ge_adr$sex=="F",1,0)

enop <- dyn_up_ge_adr$enop

vote_share_pc <- dyn_up_ge_adr$vote_share_percentage

#contest <- dyn_up_ge_adr$contested

terms <- dyn_up_ge_adr$no_terms


assets <- as.numeric(dyn_up_ge_adr$total_assets)

winner <- ifelse(dyn_up_ge_adr$position==1,1,0)

age <- as.numeric(dyn_up_ge_adr$age)


#reservation <- ifelse(dyn_up_ge_adr$constituency_type == "GEN","GEN" ,"SC/ST")

reservation_SCST <- ifelse(dyn_up_ge_adr$constituency_type == "GEN",0 ,1)

turnout <- dyn_up_ge_adr$turnout_percentage

state <- dyn_up_ge_adr$state_name

year <- dyn_up_ge_adr$year

constituency <- dyn_up_ge_adr$constituency_name_adr  

constituency_no <- dyn_up_ge_adr$constituency_no

party <- dyn_up_ge_adr$party



df <- tibble(winner ,   incumbent,constituency_no,  turncoat ,caste_UC_IC , female , terms , dynast , assets  , serious_crime, education,age, state,year,enop, reservation_SCST,recontest, constituency, party, vote_share_pc, inc, bjp)

# df_cor <- tibble(winner ,   incumbent,  turncoat , terms , dynast , assets  , serious_crime, education,age,year, enop,recontest)
# 
# 
# 
# corr <- cor(df_cor, use = "complete.obs")
# 
# corrplot::corrplot(corr, method = "circle")


```


#### Summaries {.tabset}

##### All



```{r}
mean <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~mean(., na.rm = TRUE))

min <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~min(., na.rm = TRUE))

max <- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~max(., na.rm = TRUE))

unique_n<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "uniqueN"))

n<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "length"))


sd<- df %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "dynast", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(sd= "sd"))

stat <-as.data.frame(c("Length", "Unique-N","Mean", "SD","Min", "Max")) %>% rename("stat"=1:1)




vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE) 



names(vals) <- str_remove( names(vals),"_n")


cbind(stat, vals) %>% pivot_longer(cols = 2:13) %>% pivot_wider(names_from = stat, values_from = value) %>%  kable(digits = 2,  caption = "Summary of GE 5% data") %>% kable_styling(full_width = F)

```


##### Dynasts


```{r}
mean <- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~mean(., na.rm = TRUE))

min <- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~min(., na.rm = TRUE))

max <- df%>% group_by(dynast) %>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),~max(., na.rm = TRUE))

unique_n<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms", "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "uniqueN"))

n<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(n = "length"))


sd<- df %>% group_by(dynast)%>% summarise_at( c("winner"  , "incumbent", "turncoat" ,"female" , "terms",  "assets", "serious_crime", "education","age" , "reservation_SCST", "caste_UC_IC"),list(sd= "sd"))

stat <-as.data.frame(c("Length","Length", "Unique-N","Unique-N","Mean", "Mean","SD","SD","Min","Min","Max","Max")) %>% rename("stat"=1:1)




vals <- data.table::rbindlist(list(n,unique_n,mean, sd,min, max), use.names = FALSE) 




names(vals) <- str_remove( names(vals),"_n")

vals$dynast <- ifelse(vals$dynast==1,"Family","Non-fam")



cbind(stat, vals) %>% pivot_longer(cols = 3:13) %>% pivot_wider(names_from = c(stat,dynast), values_from = value) %>%  kable(digits = 2,  caption = "Summary of GE 5% data") %>% kable_styling(full_width = F)


```



##### 5PC v/s rest


```{r}


ge0919_up <- ge0919 %>%filter(state_name %in% c("Uttar_Pradesh", "uttar pradesh") )


count <- ge0919 %>% filter(!is.na(vote_share))%>% group_by(vote_share) %>% summarise(count = n())


ge0919_up %>% filter(!is.na(vote_share))%>% group_by(vote_share) %>% summarise_at( c("vote_share_percentage", "incumbent", "turncoat" ,"female" , "no_terms", "assets_million", "liabilities_million","serious_crime","non_serious_crime", "edu","age" ),~mean(., na.rm = TRUE)) %>% inner_join(count, by ="vote_share")%>% select(1:1, 13:13, everything())%>% 
  pivot_longer(cols = 2:13) %>% pivot_wider(names_from = vote_share, values_from = value) %>% select(1:1,3:3, 2:2)%>% kable(digits = 2, col.names = c("Varibale","5+","<5")) %>% kable_styling(full_width = F)


```

##### AC summary

```{r}


dyn_up_ge_adr$serious_criminal <- ifelse(dyn_up_ge_adr$serious_crime>0,1,0)


#dyn_up_ge_adr$asset_median <- 

dyn_up_ge_adr <- dyn_up_ge_adr %>% group_by( year) %>% mutate( st_median_asset = median(as.numeric(total_assets), na.rm = TRUE)) %>% ungroup()

dyn_up_ge_adr <- dyn_up_ge_adr %>% group_by( year, constituency_no) %>% mutate(ac_avg_assets = mean(as.numeric(total_assets), na.rm = TRUE) )

dyn_up_ge_adr <- dyn_up_ge_adr %>% 
  group_by( year, constituency_no) %>% 
  mutate(dyn_vs_nondyn = ifelse(any(dyn==1) & any(dyn==0),1,0),
         dyn_won = ifelse(any(dyn==1 & position==1),1,0), 
         dyn_contest = ifelse(any(dyn==1),1,0),
         criminal_contest = ifelse(any(serious_criminal==1),1,0),
         asset_median = ifelse(ac_avg_assets>st_median_asset,1,0)
                                                                                    )


```



```{r}
dyn_up_ge_adr %>%ungroup() %>% 
  distinct(year, constituency_no, .keep_all = TRUE) %>% 
  group_by(year) %>% 
  summarise (dyn_contest = mean(dyn_contest),
             dyn_won = mean(dyn_won),
             criminal_contest = mean(criminal_contest),
             median_assets = mean(asset_median)
)%>% kable(digits = 2, col.names = c("Year","% of PCs in dynast contested","% of PCs in dynast won","% of PCs in a serious criminal contested","% of PCs in PC average assets is higher than the state median")) %>% 
  kable_styling(full_width = F)
```


#### Winner


```{r results="asis"}

#df$constituency_name_adr <- paste0(df$state,df$constituency)

df$constituency_id <- paste0(df$state,df$constituency_no)

fit_year <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age+inc+bjp | year, family = binomial(link = "probit" ), data = df )




fit_ac <- feglm(winner ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age +inc +bjp|year+constituency_id, family = binomial(link = "probit" ), data = df )




etable(fit_year, fit_ac, cluster = c("constituency"), order = order) %>% kable()%>% kable_styling(full_width = F)
```

#### Vote share

```{r results="asis"}
fit_year <- felm(vote_share_pc ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age+inc+bjp | year, data = df )


fit_ac <- felm(vote_share_pc ~   incumbent+  turncoat + female + terms + dynast + log(assets)  + serious_crime+ education+age+inc+bjp | year+constituency_id|0|constituency_id, data = df )

# 
# etable(fit_year,fit_ac, fit_party, cluster = c("constituency"), order = order) %>% kable(caption = "UP vote share")

list <- list(c("Fixed effects","Year" ,  "Year + Constiuency"), c("SE Clustered", "None","Constituency" ))



stargazer( fit_year,fit_ac,title="Vote share - UP ",type = "html",
align=TRUE, no.space=TRUE, order = order,add.lines=list)


```

































